## 本地对话-动态场景客户端实现方案

### 需求背景

本地NLU相比云端的NLU，具有低时延，高稳定性的特点，特别是在弱网环境下，如果只是依赖云端NLU，用户体验会很差。

特此产品提出通过本地NLU，用于在车控、导航、音乐等基本场景

### 整体流程图

![image-20211130142102490](https://gitee.com/moonsky/image-bed/raw/master/image-20211130142102490.png)

实际数据说明：

```shell
12-20 13:53:21.531  6781  6813 I NLUEngine-XPLocalNLU: xp local sendText (T:2315)(C:carspeechservice)at (XPLocalNLU.java:80)
--------识别结果返回--------
12-20 13:53:21.533  6781  6813 I DialogConsole: feedAsrResult asrText = 导航去肯德基soundLocation = 1asr source = ower_localmsgId = 3cdced44c948df30
--------请求本地NLU--------

12-20 13:53:21.555  6781  6813 V NluWorker_1: NluConsole processed result: {"asrResource":"ower_local","query":"导航去肯德基","semantic":{"domain":"navigation","domainConfidence":35.83679,"intent":"navigation_destination","intentConfidence":1.0,"query":"导航去肯德基","slots":[{"confidence":0.0,"name":"poi_type","rawValue":"肯德基","value":"肯德基"}]},"soundArea":1}
12-20 13:53:21.555  6781  6813 V uniteNlu: uniteNlu dynSceneData: {"packageName":"navigation","sceneId":"navigation-V1.5.0-navigation_destination-1639964663176","timestamp":1639964663176,"type":"build","contentSpace":[{"id":"PoiList","label":"目的地","props":{"canScrollDown":true,"canScrollUp":true,"intents":["global_select_serial"]},"type":"RecycleView","actions":{"ScrollByY":{}},"loadable":true,"elements":[{"loadable":true,"id":"1","label":"天河万科广场KFC","layoutLoadable":true,"position":1},{"loadable":true,"id":"2","label":"肯德基(天河万科广场店)","layoutLoadable":true,"position":2},{"loadable":true,"id":"3","label":"肯德基(棠德南店)","layoutLoadable":true,"position":3},{"loadable":true,"id":"4","label":"肯德基(五山店)","layoutLoadable":true,"position":4},{"loadable":true,"id":"5","label":"肯德基(上社店)","layoutLoadable":true,"position":5},{"loadable":true,"id":"6","label":"肯德基(棠下大舜店)","layoutLoadable":true,"position":6},{"loadable":true,"id":"7","label":"肯德基(新世界店)","layoutLoadable":true,"position":7},{"loadable":true,"id":"8","label":"肯德基(好又多店)","layoutLoadable":true,"position":8},{"loadable":true,"id":"9","label":"肯德基(中山大道店)","layoutLoadable":true,"position":9},{"loadable":true,"id":"10","label":"肯德基(东郊店)","layoutLoadable":true,"position":10},{"loadable":true,"id":"11","label":"肯德基(龙洞店)","layoutLoadable":true,"position":11},{"loadable":true,"id":"12","label":"肯德基(奥体店)","layoutLoadable":true,"position":12},{"loadable":true,"id":"13","label":"肯德基(天河客运站餐厅)","layoutLoadable":true,"position":13},{"loadable":true,"id":"14","label":"肯德基(奥体东门店)","layoutLoadable":true,"position":14},{"loadable":true,"id":"15","label":"肯德基(绿地中央广场店)","layoutLoadable":true,"position":15},{"loadable":true,"id":"16","label":"肯德基(东圃店)","layoutLoadable":true,"position":16},{"loadable":true,"id":"17","label":"肯德基(东圃四季花城店)","layoutLoadable":true,"position":17},{"loadable":true,"id":"18","label":"肯德基(沙汕DT店)","layoutLoadable":true,"position":18},{"loadable":true,"id":"19","label":"肯德基(车陂南店)","layoutLoadable":true,"position":19},{"loadable":true,"id":"20","label":"肯德基(员村店)","layoutLoadable":true,"position":20},{"loadable":true,"id":"21","label":"肯德基(龙口东店)","layoutLoadable":true,"position":21},{"loadable":true,"id":"22","label":"肯德基(石牌东店)","layoutLoadable":true,"position":22},{"loadable":true,"id":"23","label":"肯德基(石牌西店)","layoutLoadable":true,"position":23},{"loadable":true,"id":"24","label":"肯德基(粤垦店)","layoutLoadable":true,"position":24},{"loadable":true,"id":"25","label":"肯德基(百脑汇餐厅)","layoutLoadable":true,"position":25},{"loadable":true,"id":"26","label":"肯德基(燕岭店)","layoutLoadable":true,"position":26},{"loadable":true,"id":"27","label":"肯德基(天河电脑城店)","layoutLoadable":true,"position":27},{"loadable":true,"id":"28","label":"肯德基(乐都汇购物广场店)","layoutLoadable":true,"position":28},{"loadable":true,"id":"29","label":"肯德基(林和西餐厅)","layoutLoadable":true,"position":29},{"loadable":true,"id":"30","label":"肯德基(火车东站店)","layoutLoadable":true,"position":30},{"loadable":true,"id":"31","label":"肯德基(东方宝泰店)","layoutLoadable":true,"position":31},{"loadable":true,"id":"32","label":"肯德基(百福广场店)","layoutLoadable":true,"position":32},{"loadable":true,"id":"33","label":"肯德基(中信广场店)","layoutLoadable":true,"position":33},{"loadable":true,"id":"34","label":"肯德基(合一店)","layoutLoadable":true,"position":34},{"loadable":true,"id":"35","label":"肯德基(佳兆业广场店)","layoutLoadable":true,"position":35},{"loadable":true,"id":"36","label":"肯德基(梅花园餐厅)","layoutLoadable":true,"position":36},{"loadable":true,"id":"37","label":"肯德基(开创大道店)","layoutLoadable":true,"position":37},{"loadable":true,
12-20 13:53:21.556  6781  6813 V DialogManager: after DialogPolicy.selectBot domainType=navigation, nluResult=NluResult{query='导航去肯德基', asrResource='ower_local', soundArea=1, domain='navigation', semantic=Semantic{query='导航去肯德基', domain='navigation', domainConfidence=35.83679, intent='navigation_destination', intentConfidence=1.0, slots=[Slot{name='poi_type', rawValue='肯德基', value=肯德基, confidence=0.0}]}, rejectResult=null, dynSceneResult=null}
--------NLU返回解析结果--------
12-20 13:53:21.556  6781  6813 I DialogConsole: >>>onNluResult:nluResult= NluResult{query='导航去肯德基', asrResource='ower_local', soundArea=1, domain='navigation', semantic=Semantic{query='导航去肯德基', domain='navigation', domainConfidence=35.83679, intent='navigation_destination', intentConfidence=1.0, slots=[Slot{name='poi_type', rawValue='肯德基', value=肯德基, confidence=0.0}]}, rejectResult=null, dynSceneResult=null}
12-20 13:53:21.556  6781  6813 D DialogConsole: BotFactory getBot bot name=navigation
12-20 13:53:21.557  6781  6813 I NaviBot : intent = navigation_destination
--------导航bot开始检索--------
12-20 13:53:21.559  6781  6813 I NaviBot : wait poi search start
--------检索结果返回数据--------
12-20 13:53:21.623  6781 31345 I NaviBot : response = SearchResponse{requestId=407, responseCode=0, poiList=[Poi{lon=0.0, lat=0.0, id='B0GDLCIXDU', name='天河万科广场KFC', address='广州市天河区', disLon=113.4044, disLat=23.166831, navLon=0.0, navLat=0.0, distance=2134.242610293824, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B0FFK655UR', name='肯德基(天河万科广场店)', address='新塘街道高塘社区华观路1932号万科广场F1', disLon=113.404639, disLat=23.167001, navLon=0.0, navLat=0.0, distance=2164.020671938403, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B00141J4I7', name='肯德基(棠德南店)', address='棠德南路44-52号乐天棠德广场E座107-109、206-213号', disLon=113.382254, disLat=23.132118, navLon=0.0, navLat=0.0, distance=3067.2890076703916, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B00140T2KF', name='肯德基(五山店)', address='五山岳洲路9号1-2层', disLon=113.352292, disLat=23.15237, navLon=0.0, navLat=0.0, distance=3445.709931649477, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B00141J8OS', name='肯德基(上社店)', address='中山大道西上社博兴购物广场2层(近天河公园北门)', disLon=113.367389, disLat=23.132583, navLon=0.0, navLat=0.0, distance=3504.3290882833853, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B00141J4U1', name='肯德基(棠下大舜店)', address='中山大道189号A栋西1-2层(棠下大舜商务中心塘基新街路口)', disLon=113.381353, disLat=23.125982, navLon=0.0, navLat=0.0, distance=3755.318584513353, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B0FFFH9XG7', name='肯德基(新世界店)', address='中山大道西160-178号万佳百货1层', disLon=113.360463, disLat=23.133647, navLon=0.0, navLat=0.0, distance=3826.9738508324604, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B00140Q4IA', name='肯德基(好又多店)', address='中山大道188号沃尔玛1层', disLon=113.378679, disLat=23.125373, navLon=0.0, navLat=0.0, distance=3859.4776157540114, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B00141K3V2', name='肯德基(中山大道店)', address='中山大道87号车陂苏宁生活广场1层(近BRT车陂路口站)', disLon=113.396757, disLat=23.1251, navLon=0.0, navLat=0.0, distance=4016.0116207101464, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B00141IEZK', name='肯德基(东郊店)', address='中山大道路399号车陂路口卜蜂莲花1层', disLon=113.391179, disLat=23.123791, navLon=0.0, navLat=0.0, distance=4028.3873235074184, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B00141IEXW', name='肯德基(龙洞店)', address='迎龙路6号龙洞购物中心1-2层', disLon=113.366356, disLat=23.193416, navLon=0.0, navLat=0.0, distance=4220.685865703462, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B0FFF0EZTC', name='肯德基(奥体店)', address='奥体南路12号优托邦购物中心F-101之F135', disLon=113.414377, disLat=23.129915, navLon=0.0, navLat=0.0, distance=4456.514104956768, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B00141P3U4', name='肯德基(天河客运站餐厅)', address='燕岭路633号天河汽车客运站西夹层', disLon=113.34252, disLat=23.170958, navLon=0.0, navLat=0.0, distance=4530.098522728139, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B0FFKAXSCH', name='肯德基(奥体东门店)', address='广州市天河区', disLon=113.417406, disLat=23.131355, navLon=0.0, navLat=0.0, distance=4558.685530266241, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B0HB9CFFPT', name='肯德基(绿地中央广场店)', address='科学大道绿地中央广场', disLon=113.429809, disLat=23.164771, navLon=0.0, navLat=0.0, distance=4610.0251572061115, xpPoiInfo=null, matched=false}, Poi{lon=0.0, lat=0.0, id='B00140UOJX', name='肯德基(东圃店)', address='东圃大马路1号东圃购物中心A座首层', disLon=113.403434, disLat=23.120911, navLon=0.0, navLat=0.0, distance=4692.008923982676, xpPoiInfo=null, matched=fal
12-20 13:53:21.624  6781 31345 I NaviBot : newListPoi = 50
12-20 13:53:21.624  6781  6813 I NaviBot : wait poi search end
12-20 13:53:21.628  6781  6813 I NaviBot : buildAnswer tpl = null cmd = null tts = null
--------开始构建动态场景--------
12-20 13:53:21.632  6781  6813 D DynSceneManager: buildDynScene:sceneId = navigation-V1.5.0-navigation_destination-1639979601632
12-20 13:53:21.638  6781  6813 D DynSceneManager: generateNavigationList_widgetJson = {"widgetName":"default","duiWidget":"list","widgetId":"7c194334-6244-494f-b62d-25c6204eeb66","count":50,"tipsTimeout":0,"type":"list","content":[{"duiWidget":"content","subTitle":"广州市天河区","extra":{"navi":"{\"address\":\"广州市天河区\",\"category\":0,\"distance\":2134.242610293824,\"index\":-1,\"latitude\":23.166831,\"longitude\":113.4044,\"naviLat\":0,\"naviLon\":0,\"name\":\"天河万科广场KFC\",\"poiId\":\"B0GDLCIXDU\"}"},"title":"天河万科广场KFC","type":"content"},{"duiWidget":"content","subTitle":"新塘街道高塘社区华观路1932号万科广场F1","extra":{"navi":"{\"address\":\"新塘街道高塘社区华观路1932号万科广场F1\",\"category\":0,\"distance\":2164.020671938403,\"index\":-1,\"latitude\":23.167001,\"longitude\":113.404639,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(天河万科广场店)\",\"poiId\":\"B0FFK655UR\"}"},"title":"肯德基(天河万科广场店)","type":"content"},{"duiWidget":"content","subTitle":"棠德南路44-52号乐天棠德广场E座107-109、206-213号","extra":{"navi":"{\"address\":\"棠德南路44-52号乐天棠德广场E座107-109、206-213号\",\"category\":0,\"distance\":3067.2890076703916,\"index\":-1,\"latitude\":23.132118,\"longitude\":113.382254,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(棠德南店)\",\"poiId\":\"B00141J4I7\"}"},"title":"肯德基(棠德南店)","type":"content"},{"duiWidget":"content","subTitle":"五山岳洲路9号1-2层","extra":{"navi":"{\"address\":\"五山岳洲路9号1-2层\",\"category\":0,\"distance\":3445.709931649477,\"index\":-1,\"latitude\":23.15237,\"longitude\":113.352292,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(五山店)\",\"poiId\":\"B00140T2KF\"}"},"title":"肯德基(五山店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道西上社博兴购物广场2层(近天河公园北门)","extra":{"navi":"{\"address\":\"中山大道西上社博兴购物广场2层(近天河公园北门)\",\"category\":0,\"distance\":3504.3290882833853,\"index\":-1,\"latitude\":23.132583,\"longitude\":113.367389,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(上社店)\",\"poiId\":\"B00141J8OS\"}"},"title":"肯德基(上社店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道189号A栋西1-2层(棠下大舜商务中心塘基新街路口)","extra":{"navi":"{\"address\":\"中山大道189号A栋西1-2层(棠下大舜商务中心塘基新街路口)\",\"category\":0,\"distance\":3755.318584513353,\"index\":-1,\"latitude\":23.125982,\"longitude\":113.381353,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(棠下大舜店)\",\"poiId\":\"B00141J4U1\"}"},"title":"肯德基(棠下大舜店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道西160-178号万佳百货1层","extra":{"navi":"{\"address\":\"中山大道西160-178号万佳百货1层\",\"category\":0,\"distance\":3826.9738508324604,\"index\":-1,\"latitude\":23.133647,\"longitude\":113.360463,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(新世界店)\",\"poiId\":\"B0FFFH9XG7\"}"},"title":"肯德基(新世界店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道188号沃尔玛1层","extra":{"navi":"{\"address\":\"中山大道188号沃尔玛1层\",\"category\":0,\"distance\":3859.4776157540114,\"index\":-1,\"latitude\":23.125373,\"longitude\":113.378679,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(好又多店)\",\"poiId\":\"B00140Q4IA\"}"},"title":"肯德基(好又多店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道87号车陂苏宁生活广场1层(近BRT车陂路口站)","extra":{"navi":"{\"address\":\"中山大道87号车陂苏宁生活广场1层(近BRT车陂路口站)\",\"category\":0,\"distance\":4016.0116207101464,\"index\":-1,\"latitude\":23.1251,\"longitude\":113.396757,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(中山大道店)\",\"poiId\":\"B00141K3V2\"}"},"title":"肯德基(中山大道店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道路399号车
12-20 13:53:21.639  6781  6813 D NaviBot : >>>process:mCurState = State{name='state_poi_search_multi_result', triggers=null, isFinalState=0, tts='结果是第几个'}
--------返回NluResul给本地NLU DM--------
12-20 13:53:21.645  6781  6813 V DialogManager: onNluResult returned. status=continue, botResult: BotResult{answers=[Answer{cmd='null', tts='结果是第几个', tpl='null', ttsMode=0, ttsTimeout=300, widget={"widgetName":"default","duiWidget":"list","widgetId":"7c194334-6244-494f-b62d-25c6204eeb66","count":50,"tipsTimeout":0,"type":"list","content":[{"duiWidget":"content","subTitle":"广州市天河区","extra":{"navi":"{\"address\":\"广州市天河区\",\"category\":0,\"distance\":2134.242610293824,\"index\":-1,\"latitude\":23.166831,\"longitude\":113.4044,\"naviLat\":0,\"naviLon\":0,\"name\":\"天河万科广场KFC\",\"poiId\":\"B0GDLCIXDU\"}"},"title":"天河万科广场KFC","type":"content"},{"duiWidget":"content","subTitle":"新塘街道高塘社区华观路1932号万科广场F1","extra":{"navi":"{\"address\":\"新塘街道高塘社区华观路1932号万科广场F1\",\"category\":0,\"distance\":2164.020671938403,\"index\":-1,\"latitude\":23.167001,\"longitude\":113.404639,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(天河万科广场店)\",\"poiId\":\"B0FFK655UR\"}"},"title":"肯德基(天河万科广场店)","type":"content"},{"duiWidget":"content","subTitle":"棠德南路44-52号乐天棠德广场E座107-109、206-213号","extra":{"navi":"{\"address\":\"棠德南路44-52号乐天棠德广场E座107-109、206-213号\",\"category\":0,\"distance\":3067.2890076703916,\"index\":-1,\"latitude\":23.132118,\"longitude\":113.382254,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(棠德南店)\",\"poiId\":\"B00141J4I7\"}"},"title":"肯德基(棠德南店)","type":"content"},{"duiWidget":"content","subTitle":"五山岳洲路9号1-2层","extra":{"navi":"{\"address\":\"五山岳洲路9号1-2层\",\"category\":0,\"distance\":3445.709931649477,\"index\":-1,\"latitude\":23.15237,\"longitude\":113.352292,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(五山店)\",\"poiId\":\"B00140T2KF\"}"},"title":"肯德基(五山店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道西上社博兴购物广场2层(近天河公园北门)","extra":{"navi":"{\"address\":\"中山大道西上社博兴购物广场2层(近天河公园北门)\",\"category\":0,\"distance\":3504.3290882833853,\"index\":-1,\"latitude\":23.132583,\"longitude\":113.367389,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(上社店)\",\"poiId\":\"B00141J8OS\"}"},"title":"肯德基(上社店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道189号A栋西1-2层(棠下大舜商务中心塘基新街路口)","extra":{"navi":"{\"address\":\"中山大道189号A栋西1-2层(棠下大舜商务中心塘基新街路口)\",\"category\":0,\"distance\":3755.318584513353,\"index\":-1,\"latitude\":23.125982,\"longitude\":113.381353,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(棠下大舜店)\",\"poiId\":\"B00141J4U1\"}"},"title":"肯德基(棠下大舜店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道西160-178号万佳百货1层","extra":{"navi":"{\"address\":\"中山大道西160-178号万佳百货1层\",\"category\":0,\"distance\":3826.9738508324604,\"index\":-1,\"latitude\":23.133647,\"longitude\":113.360463,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(新世界店)\",\"poiId\":\"B0FFFH9XG7\"}"},"title":"肯德基(新世界店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道188号沃尔玛1层","extra":{"navi":"{\"address\":\"中山大道188号沃尔玛1层\",\"category\":0,\"distance\":3859.4776157540114,\"index\":-1,\"latitude\":23.125373,\"longitude\":113.378679,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(好又多店)\",\"poiId\":\"B00140Q4IA\"}"},"title":"肯德基(好又多店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道87号车陂苏宁生活广场1层(近BRT车陂路口站)","extra":{"navi":"{\"address\":\"中山大道87号车陂苏宁生活广场1层(近BRT车陂路口站)\",\"category\":0,\"distance\":4016.0116207101464,\"index\":-1,\"latitude\":23.1251,\"longitude\":113.396757,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(中山大道店)\",\"poiId\":\"B00141K3
12-20 13:53:21.646  6781  6813 V DialogManager: validateBotResult before, stackList len = 1
12-20 13:53:21.654  6781  6813 V DialogManager: validateBotResult after, stackList len = 2
12-20 13:53:21.656  6781  6813 V DialogManager: DialogPolicy make policy finish. status=continue, botResult: BotResult{answers=[Answer{cmd='null', tts='结果是第几个', tpl='null', ttsMode=0, ttsTimeout=300, widget={"widgetName":"default","duiWidget":"list","widgetId":"7c194334-6244-494f-b62d-25c6204eeb66","count":50,"tipsTimeout":0,"type":"list","content":[{"duiWidget":"content","subTitle":"广州市天河区","extra":{"navi":"{\"address\":\"广州市天河区\",\"category\":0,\"distance\":2134.242610293824,\"index\":-1,\"latitude\":23.166831,\"longitude\":113.4044,\"naviLat\":0,\"naviLon\":0,\"name\":\"天河万科广场KFC\",\"poiId\":\"B0GDLCIXDU\"}"},"title":"天河万科广场KFC","type":"content"},{"duiWidget":"content","subTitle":"新塘街道高塘社区华观路1932号万科广场F1","extra":{"navi":"{\"address\":\"新塘街道高塘社区华观路1932号万科广场F1\",\"category\":0,\"distance\":2164.020671938403,\"index\":-1,\"latitude\":23.167001,\"longitude\":113.404639,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(天河万科广场店)\",\"poiId\":\"B0FFK655UR\"}"},"title":"肯德基(天河万科广场店)","type":"content"},{"duiWidget":"content","subTitle":"棠德南路44-52号乐天棠德广场E座107-109、206-213号","extra":{"navi":"{\"address\":\"棠德南路44-52号乐天棠德广场E座107-109、206-213号\",\"category\":0,\"distance\":3067.2890076703916,\"index\":-1,\"latitude\":23.132118,\"longitude\":113.382254,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(棠德南店)\",\"poiId\":\"B00141J4I7\"}"},"title":"肯德基(棠德南店)","type":"content"},{"duiWidget":"content","subTitle":"五山岳洲路9号1-2层","extra":{"navi":"{\"address\":\"五山岳洲路9号1-2层\",\"category\":0,\"distance\":3445.709931649477,\"index\":-1,\"latitude\":23.15237,\"longitude\":113.352292,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(五山店)\",\"poiId\":\"B00140T2KF\"}"},"title":"肯德基(五山店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道西上社博兴购物广场2层(近天河公园北门)","extra":{"navi":"{\"address\":\"中山大道西上社博兴购物广场2层(近天河公园北门)\",\"category\":0,\"distance\":3504.3290882833853,\"index\":-1,\"latitude\":23.132583,\"longitude\":113.367389,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(上社店)\",\"poiId\":\"B00141J8OS\"}"},"title":"肯德基(上社店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道189号A栋西1-2层(棠下大舜商务中心塘基新街路口)","extra":{"navi":"{\"address\":\"中山大道189号A栋西1-2层(棠下大舜商务中心塘基新街路口)\",\"category\":0,\"distance\":3755.318584513353,\"index\":-1,\"latitude\":23.125982,\"longitude\":113.381353,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(棠下大舜店)\",\"poiId\":\"B00141J4U1\"}"},"title":"肯德基(棠下大舜店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道西160-178号万佳百货1层","extra":{"navi":"{\"address\":\"中山大道西160-178号万佳百货1层\",\"category\":0,\"distance\":3826.9738508324604,\"index\":-1,\"latitude\":23.133647,\"longitude\":113.360463,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(新世界店)\",\"poiId\":\"B0FFFH9XG7\"}"},"title":"肯德基(新世界店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道188号沃尔玛1层","extra":{"navi":"{\"address\":\"中山大道188号沃尔玛1层\",\"category\":0,\"distance\":3859.4776157540114,\"index\":-1,\"latitude\":23.125373,\"longitude\":113.378679,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(好又多店)\",\"poiId\":\"B00140Q4IA\"}"},"title":"肯德基(好又多店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道87号车陂苏宁生活广场1层(近BRT车陂路口站)","extra":{"navi":"{\"address\":\"中山大道87号车陂苏宁生活广场1层(近BRT车陂路口站)\",\"category\":0,\"distance\":4016.0116207101464,\"index\":-1,\"latitude\":23.1251,\"longitude\":113.396757,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(中山大道店)\",\"poiId\"
12-20 13:53:21.656  6781  6813 V DialogManager: StoryId compare. pendingTaskStoryId=navigation1639979601639, currentStoryId=navigation1639979601639
12-20 13:53:21.662  6781  6813 I DialogConsole: >>>onLastResult BotResult=BotResult{answers=[Answer{cmd='null', tts='结果是第几个', tpl='null', ttsMode=0, ttsTimeout=300, widget={"widgetName":"default","duiWidget":"list","widgetId":"7c194334-6244-494f-b62d-25c6204eeb66","count":50,"tipsTimeout":0,"type":"list","content":[{"duiWidget":"content","subTitle":"广州市天河区","extra":{"navi":"{\"address\":\"广州市天河区\",\"category\":0,\"distance\":2134.242610293824,\"index\":-1,\"latitude\":23.166831,\"longitude\":113.4044,\"naviLat\":0,\"naviLon\":0,\"name\":\"天河万科广场KFC\",\"poiId\":\"B0GDLCIXDU\"}"},"title":"天河万科广场KFC","type":"content"},{"duiWidget":"content","subTitle":"新塘街道高塘社区华观路1932号万科广场F1","extra":{"navi":"{\"address\":\"新塘街道高塘社区华观路1932号万科广场F1\",\"category\":0,\"distance\":2164.020671938403,\"index\":-1,\"latitude\":23.167001,\"longitude\":113.404639,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(天河万科广场店)\",\"poiId\":\"B0FFK655UR\"}"},"title":"肯德基(天河万科广场店)","type":"content"},{"duiWidget":"content","subTitle":"棠德南路44-52号乐天棠德广场E座107-109、206-213号","extra":{"navi":"{\"address\":\"棠德南路44-52号乐天棠德广场E座107-109、206-213号\",\"category\":0,\"distance\":3067.2890076703916,\"index\":-1,\"latitude\":23.132118,\"longitude\":113.382254,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(棠德南店)\",\"poiId\":\"B00141J4I7\"}"},"title":"肯德基(棠德南店)","type":"content"},{"duiWidget":"content","subTitle":"五山岳洲路9号1-2层","extra":{"navi":"{\"address\":\"五山岳洲路9号1-2层\",\"category\":0,\"distance\":3445.709931649477,\"index\":-1,\"latitude\":23.15237,\"longitude\":113.352292,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(五山店)\",\"poiId\":\"B00140T2KF\"}"},"title":"肯德基(五山店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道西上社博兴购物广场2层(近天河公园北门)","extra":{"navi":"{\"address\":\"中山大道西上社博兴购物广场2层(近天河公园北门)\",\"category\":0,\"distance\":3504.3290882833853,\"index\":-1,\"latitude\":23.132583,\"longitude\":113.367389,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(上社店)\",\"poiId\":\"B00141J8OS\"}"},"title":"肯德基(上社店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道189号A栋西1-2层(棠下大舜商务中心塘基新街路口)","extra":{"navi":"{\"address\":\"中山大道189号A栋西1-2层(棠下大舜商务中心塘基新街路口)\",\"category\":0,\"distance\":3755.318584513353,\"index\":-1,\"latitude\":23.125982,\"longitude\":113.381353,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(棠下大舜店)\",\"poiId\":\"B00141J4U1\"}"},"title":"肯德基(棠下大舜店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道西160-178号万佳百货1层","extra":{"navi":"{\"address\":\"中山大道西160-178号万佳百货1层\",\"category\":0,\"distance\":3826.9738508324604,\"index\":-1,\"latitude\":23.133647,\"longitude\":113.360463,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(新世界店)\",\"poiId\":\"B0FFFH9XG7\"}"},"title":"肯德基(新世界店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道188号沃尔玛1层","extra":{"navi":"{\"address\":\"中山大道188号沃尔玛1层\",\"category\":0,\"distance\":3859.4776157540114,\"index\":-1,\"latitude\":23.125373,\"longitude\":113.378679,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(好又多店)\",\"poiId\":\"B00140Q4IA\"}"},"title":"肯德基(好又多店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道87号车陂苏宁生活广场1层(近BRT车陂路口站)","extra":{"navi":"{\"address\":\"中山大道87号车陂苏宁生活广场1层(近BRT车陂路口站)\",\"category\":0,\"distance\":4016.0116207101464,\"index\":-1,\"latitude\":23.1251,\"longitude\":113.396757,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(中山大道店)\",\"poiId\":\"B00141K3V2\"}"},"title":"肯德?
12-20 13:53:21.662  6781  6813 I DialogConsole: DM status =continue
--------语义结果返回给NLP--------
12-20 13:53:21.662  6781  6813 I XPLocalNlp: parseLocalDialogResult 200，status：continue (T:2315)(C:carspeechservice)at (XPLocalNlp.java:129)
12-20 13:53:21.663  6781  6813 I XPLocalNlp: parseAnswers null (T:2315)(C:carspeechservice)at (XPLocalNlp.java:217)
12-20 13:53:21.663  6781  6813 I XPLocalNlp: localDialogListener parseLocalDialogResult NLUResult{nluId=0, sessionId='7b2977b8-7d51-4148-93c0-393a99758d1c', domain='navigation', showText='结果是第几个', asrResource='ower_local',EventIntent=[EventIntent{intent='navigation_destination', event='null', delay=0, param=null, xiaopExpression=null, showText=结果是第几个, nlgText=结果是第几个, tips=null}]'} (T:2315)(C:carspeechservice)at (XPLocalNlp.java:109)
12-20 13:53:21.665  6781  6813 I DialogConsole: 返回端上数据==LocalDialogResult{code=200, text='null', avatarExpression='null', domain='navigation', status='continue', semantic=Semantic{query='导航去肯德基', domain='navigation', domainConfidence=35.83679, intent='navigation_destination', intentConfidence=1.0, slots=[Slot{name='poi_type', rawValue='肯德基', value=肯德基, confidence=0.0}]}, score=0, shieldTts=0, answer=[Answer{cmd='null', tts='结果是第几个', tpl='null', ttsMode=0, ttsTimeout=300, widget={"widgetName":"default","duiWidget":"list","widgetId":"7c194334-6244-494f-b62d-25c6204eeb66","count":50,"tipsTimeout":0,"type":"list","content":[{"duiWidget":"content","subTitle":"广州市天河区","extra":{"navi":"{\"address\":\"广州市天河区\",\"category\":0,\"distance\":2134.242610293824,\"index\":-1,\"latitude\":23.166831,\"longitude\":113.4044,\"naviLat\":0,\"naviLon\":0,\"name\":\"天河万科广场KFC\",\"poiId\":\"B0GDLCIXDU\"}"},"title":"天河万科广场KFC","type":"content"},{"duiWidget":"content","subTitle":"新塘街道高塘社区华观路1932号万科广场F1","extra":{"navi":"{\"address\":\"新塘街道高塘社区华观路1932号万科广场F1\",\"category\":0,\"distance\":2164.020671938403,\"index\":-1,\"latitude\":23.167001,\"longitude\":113.404639,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(天河万科广场店)\",\"poiId\":\"B0FFK655UR\"}"},"title":"肯德基(天河万科广场店)","type":"content"},{"duiWidget":"content","subTitle":"棠德南路44-52号乐天棠德广场E座107-109、206-213号","extra":{"navi":"{\"address\":\"棠德南路44-52号乐天棠德广场E座107-109、206-213号\",\"category\":0,\"distance\":3067.2890076703916,\"index\":-1,\"latitude\":23.132118,\"longitude\":113.382254,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(棠德南店)\",\"poiId\":\"B00141J4I7\"}"},"title":"肯德基(棠德南店)","type":"content"},{"duiWidget":"content","subTitle":"五山岳洲路9号1-2层","extra":{"navi":"{\"address\":\"五山岳洲路9号1-2层\",\"category\":0,\"distance\":3445.709931649477,\"index\":-1,\"latitude\":23.15237,\"longitude\":113.352292,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(五山店)\",\"poiId\":\"B00140T2KF\"}"},"title":"肯德基(五山店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道西上社博兴购物广场2层(近天河公园北门)","extra":{"navi":"{\"address\":\"中山大道西上社博兴购物广场2层(近天河公园北门)\",\"category\":0,\"distance\":3504.3290882833853,\"index\":-1,\"latitude\":23.132583,\"longitude\":113.367389,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(上社店)\",\"poiId\":\"B00141J8OS\"}"},"title":"肯德基(上社店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道189号A栋西1-2层(棠下大舜商务中心塘基新街路口)","extra":{"navi":"{\"address\":\"中山大道189号A栋西1-2层(棠下大舜商务中心塘基新街路口)\",\"category\":0,\"distance\":3755.318584513353,\"index\":-1,\"latitude\":23.125982,\"longitude\":113.381353,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(棠下大舜店)\",\"poiId\":\"B00141J4U1\"}"},"title":"肯德基(棠下大舜店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道西160-178号万佳百货1层","extra":{"navi":"{\"address\":\"中山大道西160-178号万佳百货1层\",\"category\":0,\"distance\":3826.9738508324604,\"index\":-1,\"latitude\":23.133647,\"longitude\":113.360463,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(新世界店)\",\"poiId\":\"B0FFFH9XG7\"}"},"title":"肯德基(新世界店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道188号沃尔玛1层","extra":{"navi":"{\"address\":\"中山大道188号沃尔玛1层\",\"category\":0,\"distance\":3859.4776157540114,\"index\":-1,\"latitude\":23.125373,\"longitude\":113.378679,\"naviLat\":0,\"naviLon\":0,\"name\":\"肯德基(好又多店)\",\"poiId\":\"B00140Q4IA\"}"},"title":"肯德基(好又多店)","type":"content"},{"duiWidget":"content","subTitle":"中山大道87号车陂苏宁生活广场1?
12-20 13:53:21.677  6781  6813 V NluWorker_1: sentences json object: [{"begin":0,"channel":1,"dynSceneDataMap":{"navigation":[{"nameValuePairs":{"packageName":"navigation","sceneId":"navigation-V1.5.0-navigation_destination-1639964663176","timestamp":1639964663176,"type":"build","contentSpace":{"values":[{"nameValuePairs":{"id":"PoiList","label":"目的地","props":{"nameValuePairs":{"canScrollDown":true,"canScrollUp":true,"intents":{"values":["global_select_serial"]}}},"type":"RecycleView","actions":{"nameValuePairs":{"ScrollByY":{"nameValuePairs":{}}}},"loadable":true,"elements":{"values":[{"nameValuePairs":{"loadable":true,"id":"1","label":"天河万科广场KFC","layoutLoadable":true,"position":1}},{"nameValuePairs":{"loadable":true,"id":"2","label":"肯德基(天河万科广场店)","layoutLoadable":true,"position":2}},{"nameValuePairs":{"loadable":true,"id":"3","label":"肯德基(棠德南店)","layoutLoadable":true,"position":3}},{"nameValuePairs":{"loadable":true,"id":"4","label":"肯德基(五山店)","layoutLoadable":true,"position":4}},{"nameValuePairs":{"loadable":true,"id":"5","label":"肯德基(上社店)","layoutLoadable":true,"position":5}},{"nameValuePairs":{"loadable":true,"id":"6","label":"肯德基(棠下大舜店)","layoutLoadable":true,"position":6}},{"nameValuePairs":{"loadable":true,"id":"7","label":"肯德基(新世界店)","layoutLoadable":true,"position":7}},{"nameValuePairs":{"loadable":true,"id":"8","label":"肯德基(好又多店)","layoutLoadable":true,"position":8}},{"nameValuePairs":{"loadable":true,"id":"9","label":"肯德基(中山大道店)","layoutLoadable":true,"position":9}},{"nameValuePairs":{"loadable":true,"id":"10","label":"肯德基(东郊店)","layoutLoadable":true,"position":10}},{"nameValuePairs":{"loadable":true,"id":"11","label":"肯德基(龙洞店)","layoutLoadable":true,"position":11}},{"nameValuePairs":{"loadable":true,"id":"12","label":"肯德基(奥体店)","layoutLoadable":true,"position":12}},{"nameValuePairs":{"loadable":true,"id":"13","label":"肯德基(天河客运站餐厅)","layoutLoadable":true,"position":13}},{"nameValuePairs":{"loadable":true,"id":"14","label":"肯德基(奥体东门店)","layoutLoadable":true,"position":14}},{"nameValuePairs":{"loadable":true,"id":"15","label":"肯德基(绿地中央广场店)","layoutLoadable":true,"position":15}},{"nameValuePairs":{"loadable":true,"id":"16","label":"肯德基(东圃店)","layoutLoadable":true,"position":16}},{"nameValuePairs":{"loadable":true,"id":"17","label":"肯德基(东圃四季花城店)","layoutLoadable":true,"position":17}},{"nameValuePairs":{"loadable":true,"id":"18","label":"肯德基(沙汕DT店)","layoutLoadable":true,"position":18}},{"nameValuePairs":{"loadable":true,"id":"19","label":"肯德基(车陂南店)","layoutLoadable":true,"position":19}},{"nameValuePairs":{"loadable":true,"id":"20","label":"肯德基(员村店)","layoutLoadable":true,"position":20}},{"nameValuePairs":{"loadable":true,"id":"21","label":"肯德基(龙口东店)","layoutLoadable":true,"position":21}},{"nameValuePairs":{"loadable":true,"id":"22","label":"肯德基(石牌东店)","layoutLoadable":true,"position":22}},{"nameValuePairs":{"loadable":true,"id":"23","label":"肯德基(石牌西店)","layoutLoadable":true,"position":23}},{"nameValuePairs":{"loadable":true,"id":"24","label":"肯德基(粤垦店)","layoutLoadable":true,"position":24}},{"nameValuePairs":{"loadable":true,"id":"25","label":"肯德基(百脑汇餐厅)","layoutLoadable":true,"position":25}},{"nameValuePairs":{"loadable":true,"id":"26","label":"肯德基(燕岭店)","layoutLoadable":true,"position":26}},{"nameValuePairs":{"loadable":true,"id":"27","label":"肯德基(天河电脑城店)","layoutLoadable":true,"position":27}},{"nameValuePairs":{"loadable":true,"id":"28","label":"肯德基(乐都汇购物广场店)","layoutLoadable":true,"position":28}},{"nameValuePairs":{"loadable":true,"id":"29","label":"肯德基(林和西餐厅)","layoutLoadable":true,"position":29}},{"nameValuePairs":{"loadable":true,"id":"30","label":"肯德基(火车东站店)","layo
12-20 13:53:21.679  6781  6813 I NLUEngine-XPLocalNLU: onLocalDialogResult:XPLocalDialogResult{mNluResult=NLUResult{nluId=0, sessionId='7b2977b8-7d51-4148-93c0-393a99758d1c', domain='navigation', showText='结果是第几个', asrResource='ower_local',EventIntent=[EventIntent{intent='navigation_destination', event='null', delay=0, param=null, xiaopExpression=null, showText=结果是第几个, nlgText=结果是第几个, tips=null}]'}} (T:2315)(C:carspeechservice)at (XPLocalNLU.java:90)


--------第二轮：用户说‘第三个’--------
12-20 13:53:25.293  6781  6813 I NLUEngine-XPLocalNLU: xp local sendText (T:2315)(C:carspeechservice)at (XPLocalNLU.java:80)
12-20 13:53:25.294  6781  6813 D EnvUtils: isOpenXpLocalFeature:on (T:2315)(C:carspeechservice)at (EnvUtils.java:490)
12-20 13:53:25.295  6781  6813 I DialogConsole: feedAsrResult asrText = 第三个soundLocation = 1asr source = ower_localmsgId = 616e5a263f04d68
12-20 13:53:25.295  6781  6813 V NluWorker_1: NluConsole processed dynSceneIds: [navigation-V1.5.0-navigation_destination-1639979601632]
--------根据上面生成的动态场景ID来获取动态场景数据--------
12-20 13:53:25.295  6781  6813 I DialogConsole: >>>getDynScene:navigation-V1.5.0-navigation_destination-1639979601632
12-20 13:53:25.296  6781  6813 D DynSceneManager: getSceneByID:sceneID=navigation-V1.5.0-navigation_destination-1639979601632|dynSceneObj={"packageName":"navigation","sceneId":"navigation-V1.5.0-navigation_destination-1639979601632","timestamp":1639979601632,"type":"build","contentSpace":[{"id":"PoiList","label":"目的地","props":{"canScrollDown":true,"canScrollUp":true,"intents":["global_select_serial"]},"type":"RecycleView","actions":{"ScrollByY":{}},"loadable":true,"elements":[{"loadable":true,"id":"1","label":"天河万科广场KFC","layoutLoadable":true,"position":1},{"loadable":true,"id":"2","label":"肯德基(天河万科广场店)","layoutLoadable":true,"position":2},{"loadable":true,"id":"3","label":"肯德基(棠德南店)","layoutLoadable":true,"position":3},{"loadable":true,"id":"4","label":"肯德基(五山店)","layoutLoadable":true,"position":4},{"loadable":true,"id":"5","label":"肯德基(上社店)","layoutLoadable":true,"position":5},{"loadable":true,"id":"6","label":"肯德基(棠下大舜店)","layoutLoadable":true,"position":6},{"loadable":true,"id":"7","label":"肯德基(新世界店)","layoutLoadable":true,"position":7},{"loadable":true,"id":"8","label":"肯德基(好又多店)","layoutLoadable":true,"position":8},{"loadable":true,"id":"9","label":"肯德基(中山大道店)","layoutLoadable":true,"position":9},{"loadable":true,"id":"10","label":"肯德基(东郊店)","layoutLoadable":true,"position":10},{"loadable":true,"id":"11","label":"肯德基(龙洞店)","layoutLoadable":true,"position":11},{"loadable":true,"id":"12","label":"肯德基(奥体店)","layoutLoadable":true,"position":12},{"loadable":true,"id":"13","label":"肯德基(天河客运站餐厅)","layoutLoadable":true,"position":13},{"loadable":true,"id":"14","label":"肯德基(奥体东门店)","layoutLoadable":true,"position":14},{"loadable":true,"id":"15","label":"肯德基(绿地中央广场店)","layoutLoadable":true,"position":15},{"loadable":true,"id":"16","label":"肯德基(东圃店)","layoutLoadable":true,"position":16},{"loadable":true,"id":"17","label":"肯德基(东圃四季花城店)","layoutLoadable":true,"position":17},{"loadable":true,"id":"18","label":"肯德基(沙汕DT店)","layoutLoadable":true,"position":18},{"loadable":true,"id":"19","label":"肯德基(车陂南店)","layoutLoadable":true,"position":19},{"loadable":true,"id":"20","label":"肯德基(员村店)","layoutLoadable":true,"position":20},{"loadable":true,"id":"21","label":"肯德基(龙口东店)","layoutLoadable":true,"position":21},{"loadable":true,"id":"22","label":"肯德基(石牌东店)","layoutLoadable":true,"position":22},{"loadable":true,"id":"23","label":"肯德基(石牌西店)","layoutLoadable":true,"position":23},{"loadable":true,"id":"24","label":"肯德基(粤垦店)","layoutLoadable":true,"position":24},{"loadable":true,"id":"25","label":"肯德基(百脑汇餐厅)","layoutLoadable":true,"position":25},{"loadable":true,"id":"26","label":"肯德基(燕岭店)","layoutLoadable":true,"position":26},{"loadable":true,"id":"27","label":"肯德基(天河电脑城店)","layoutLoadable":true,"position":27},{"loadable":true,"id":"28","label":"肯德基(乐都汇购物广场店)","layoutLoadable":true,"position":28},{"loadable":true,"id":"29","label":"肯德基(林和西餐厅)","layoutLoadable":true,"position":29},{"loadable":true,"id":"30","label":"肯德基(火车东站店)","layoutLoadable":true,"position":30},{"loadable":true,"id":"31","label":"肯德基(东方宝泰店)","layoutLoadable":true,"position":31},{"loadable":true,"id":"32","label":"肯德基(百福广场店)","layoutLoadable":true,"position":32},{"loadable":true,"id":"33","label":"肯德基(中信广场店)","layoutLoadable":true,"position":33},{"loadable":true,"id":"34","label":"肯德基(合一店)","layoutLoadable":true,"position":34},{"loadable":true,"id":"35","label":"肯德基(佳兆业广场店)","layoutLoadable":true,"position":35},{"loadable":true,"id":"36","label":"肯德基(梅花园餐厅)","layoutLoadable":true,"position":36},{"loadable":true,"id":"37","label":"肯德基(
12-20 13:53:25.304  6781  6813 V NluWorker_1: NluConsole processed result: {"asrResource":"ower_local","query":"第三个","semantic":{"domain":"global","domainConfidence":0.9988,"intent":"global_select","intentConfidence":0.9988,"query":"第三个","slots":[{"confidence":1.0,"name":"serial","rawValue":"第三个","value":"3"}]},"soundArea":1}
12-20 13:53:25.305  6781  6813 V uniteNlu: uniteNlu dynSceneData: {"packageName":"navigation","sceneId":"navigation-V1.5.0-navigation_destination-1639979601632","timestamp":1639979601632,"type":"build","contentSpace":[{"id":"PoiList","label":"目的地","props":{"canScrollDown":true,"canScrollUp":true,"intents":["global_select_serial"]},"type":"RecycleView","actions":{"ScrollByY":{}},"loadable":true,"elements":[{"loadable":true,"id":"1","label":"天河万科广场KFC","layoutLoadable":true,"position":1},{"loadable":true,"id":"2","label":"肯德基(天河万科广场店)","layoutLoadable":true,"position":2},{"loadable":true,"id":"3","label":"肯德基(棠德南店)","layoutLoadable":true,"position":3},{"loadable":true,"id":"4","label":"肯德基(五山店)","layoutLoadable":true,"position":4},{"loadable":true,"id":"5","label":"肯德基(上社店)","layoutLoadable":true,"position":5},{"loadable":true,"id":"6","label":"肯德基(棠下大舜店)","layoutLoadable":true,"position":6},{"loadable":true,"id":"7","label":"肯德基(新世界店)","layoutLoadable":true,"position":7},{"loadable":true,"id":"8","label":"肯德基(好又多店)","layoutLoadable":true,"position":8},{"loadable":true,"id":"9","label":"肯德基(中山大道店)","layoutLoadable":true,"position":9},{"loadable":true,"id":"10","label":"肯德基(东郊店)","layoutLoadable":true,"position":10},{"loadable":true,"id":"11","label":"肯德基(龙洞店)","layoutLoadable":true,"position":11},{"loadable":true,"id":"12","label":"肯德基(奥体店)","layoutLoadable":true,"position":12},{"loadable":true,"id":"13","label":"肯德基(天河客运站餐厅)","layoutLoadable":true,"position":13},{"loadable":true,"id":"14","label":"肯德基(奥体东门店)","layoutLoadable":true,"position":14},{"loadable":true,"id":"15","label":"肯德基(绿地中央广场店)","layoutLoadable":true,"position":15},{"loadable":true,"id":"16","label":"肯德基(东圃店)","layoutLoadable":true,"position":16},{"loadable":true,"id":"17","label":"肯德基(东圃四季花城店)","layoutLoadable":true,"position":17},{"loadable":true,"id":"18","label":"肯德基(沙汕DT店)","layoutLoadable":true,"position":18},{"loadable":true,"id":"19","label":"肯德基(车陂南店)","layoutLoadable":true,"position":19},{"loadable":true,"id":"20","label":"肯德基(员村店)","layoutLoadable":true,"position":20},{"loadable":true,"id":"21","label":"肯德基(龙口东店)","layoutLoadable":true,"position":21},{"loadable":true,"id":"22","label":"肯德基(石牌东店)","layoutLoadable":true,"position":22},{"loadable":true,"id":"23","label":"肯德基(石牌西店)","layoutLoadable":true,"position":23},{"loadable":true,"id":"24","label":"肯德基(粤垦店)","layoutLoadable":true,"position":24},{"loadable":true,"id":"25","label":"肯德基(百脑汇餐厅)","layoutLoadable":true,"position":25},{"loadable":true,"id":"26","label":"肯德基(燕岭店)","layoutLoadable":true,"position":26},{"loadable":true,"id":"27","label":"肯德基(天河电脑城店)","layoutLoadable":true,"position":27},{"loadable":true,"id":"28","label":"肯德基(乐都汇购物广场店)","layoutLoadable":true,"position":28},{"loadable":true,"id":"29","label":"肯德基(林和西餐厅)","layoutLoadable":true,"position":29},{"loadable":true,"id":"30","label":"肯德基(火车东站店)","layoutLoadable":true,"position":30},{"loadable":true,"id":"31","label":"肯德基(东方宝泰店)","layoutLoadable":true,"position":31},{"loadable":true,"id":"32","label":"肯德基(百福广场店)","layoutLoadable":true,"position":32},{"loadable":true,"id":"33","label":"肯德基(中信广场店)","layoutLoadable":true,"position":33},{"loadable":true,"id":"34","label":"肯德基(合一店)","layoutLoadable":true,"position":34},{"loadable":true,"id":"35","label":"肯德基(佳兆业广场店)","layoutLoadable":true,"position":35},{"loadable":true,"id":"36","label":"肯德基(梅花园餐厅)","layoutLoadable":true,"position":36},{"loadable":true,"id":"37","label":"肯德基(开创大道店)","layoutLoadable":true,"position":37},{"loadable":true,
12-20 13:53:25.306  6781  6813 V uniteNlu: uniteNlu dynSceneResult: DynSceneResult{domain='navigation', intent='set', sceneId='null', elements=[SceneElement{id='3', value='null', actions=null}]}
12-20 13:53:25.306  6781  6813 V DialogPolicy: selectBot：dynSceneResult Domain  =  navigation
12-20 13:53:25.306  6781  6813 V DialogPolicy: selectBot：dynSceneResult pendingTask Domain  =  navigation
12-20 13:53:25.306  6781  6813 V DialogManager: after DialogPolicy.selectBot domainType=navigation, nluResult=NluResult{query='第三个', asrResource='ower_local', soundArea=1, domain='navigation', semantic=Semantic{query='第三个', domain='global', domainConfidence=0.9988, intent='global_select', intentConfidence=0.9988, slots=[Slot{name='serial', rawValue='第三个', value=3, confidence=1.0}]}, rejectResult=null, dynSceneResult=DynSceneResult{domain='navigation', intent='set', sceneId='null', elements=[SceneElement{id='3', value='null', actions=null}]}}

--------返回对应的动态场景元素信息--------
12-20 13:53:25.307  6781  6813 I DialogConsole: >>>onNluResult:nluResult= NluResult{query='第三个', asrResource='ower_local', soundArea=1, domain='navigation', semantic=Semantic{query='第三个', domain='global', domainConfidence=0.9988, intent='global_select', intentConfidence=0.9988, slots=[Slot{name='serial', rawValue='第三个', value=3, confidence=1.0}]}, rejectResult=null, dynSceneResult=DynSceneResult{domain='navigation', intent='set', sceneId='null', elements=[SceneElement{id='3', value='null', actions=null}]}}
12-20 13:53:25.307  6781  6813 D DialogConsole: BotFactory getBot bot name=navigation
--------根据动态场景元素，构建answer--------
12-20 13:53:25.307  6781  6813 D NaviBot : buildAnswer:poi = Poi{lon=0.0, lat=0.0, id='B00141J4I7', name='肯德基(棠德南店)', address='棠德南路44-52号乐天棠德广场E座107-109、206-213号', disLon=113.382254, disLat=23.132118, navLon=0.0, navLat=0.0, distance=3067.2890076703916, xpPoiInfo=null, matched=false}
12-20 13:53:25.307  6781  6813 D NaviBot : buildAnswer:paramObject = {"naviType":1,"poi":{"naviLat":23.132118,"naviLon":113.382254,"latitude":23.132118,"longitude":113.382254,"entrLocation":{"latitude":23.132118,"longitude":113.382254}}}
12-20 13:53:25.307  6781  6813 D NaviBot : >>>process:mCurState = State{name='state_poi_search_confirm', triggers=[Trigger{intent='global_select', slots=null, next_state=null}], isFinalState=1, tts='好的'}
12-20 13:53:25.307  6781  6813 V DialogManager: onNluResult returned. status=wait, botResult: BotResult{answers=[Answer{cmd='command://navi.control.start', tts='好的', tpl='null', ttsMode=0, ttsTimeout=300, widget=null, intent='3', holdTime=0, runSequence=2, delay=0, param={"naviType":1,"poi":{"naviLat":23.132118,"naviLon":113.382254,"latitude":23.132118,"longitude":113.382254,"entrLocation":{"latitude":23.132118,"longitude":113.382254}}}, action=null}], status='wait', confidence=0, domain='navigation', matched=true, intent='3', query='null', semantic=Semantic{query='第三个', domain='global', domainConfidence=0.9988, intent='global_select', intentConfidence=0.9988, slots=[Slot{name='serial', rawValue='第三个', value=3, confidence=1.0}]}, storyId='navigation1639979605307', dynSceneIds=null, storyState='null'}
12-20 13:53:25.308  6781  6813 V DialogManager: validateBotResult before, stackList len = 2
12-20 13:53:25.308  6781  6813 V DialogPolicy: 入口DialogPolicy.validateBotResult时，botResult=BotResult{answers=[Answer{cmd='command://navi.control.start', tts='好的', tpl='null', ttsMode=0, ttsTimeout=300, widget=null, intent='3', holdTime=0, runSequence=2, delay=0, param={"naviType":1,"poi":{"naviLat":23.132118,"naviLon":113.382254,"latitude":23.132118,"longitude":113.382254,"entrLocation":{"latitude":23.132118,"longitude":113.382254}}}, action=null}], status='wait', confidence=0, domain='navigation', matched=true, intent='3', query='null', semantic=Semantic{query='第三个', domain='global', domainConfidence=0.9988, intent='global_select', intentConfidence=0.9988, slots=[Slot{name='serial', rawValue='第三个', value=3, confidence=1.0}]}, storyId='navigation1639979605307', dynSceneIds=null, storyState='null'}
12-20 13:53:25.310  6781  6813 V DialogManager: validateBotResult after, stackList len = 2
12-20 13:53:25.311  6781  6813 V DialogManager: DialogPolicy make policy finish. status=wait, botResult: BotResult{answers=[Answer{cmd='command://navi.control.start', tts='好的', tpl='null', ttsMode=0, ttsTimeout=300, widget=null, intent='3', holdTime=0, runSequence=2, delay=0, param={"naviType":1,"poi":{"naviLat":23.132118,"naviLon":113.382254,"latitude":23.132118,"longitude":113.382254,"entrLocation":{"latitude":23.132118,"longitude":113.382254}}}, action=null}], status='wait', confidence=0, domain='navigation', matched=true, intent='3', query='null', semantic=Semantic{query='第三个', domain='global', domainConfidence=0.9988, intent='global_select', intentConfidence=0.9988, slots=[Slot{name='serial', rawValue='第三个', value=3, confidence=1.0}]}, storyId='navigation1639979605307', dynSceneIds=null, storyState='null'}
12-20 13:53:25.311  6781  6813 V DialogManager: StoryId compare. pendingTaskStoryId=navigation1639979601639, currentStoryId=navigation1639979605307
12-20 13:53:25.311  6781  6813 V DialogManager: force follow pending task status, stackList len = 2
12-20 13:53:25.311  6781  6813 V DialogManager: old status=continue, then update DST, to next step fine some pending task in stack，so status of botResult will set to continue
12-20 13:53:25.314  6781  6813 I DialogConsole: >>>onLastResult BotResult=BotResult{answers=[Answer{cmd='command://navi.control.start', tts='好的', tpl='null', ttsMode=0, ttsTimeout=300, widget=null, intent='3', holdTime=0, runSequence=2, delay=0, param={"naviType":1,"poi":{"naviLat":23.132118,"naviLon":113.382254,"latitude":23.132118,"longitude":113.382254,"entrLocation":{"latitude":23.132118,"longitude":113.382254}}}, action=null}], status='continue', confidence=0, domain='navigation', matched=true, intent='3', query='null', semantic=Semantic{query='第三个', domain='global', domainConfidence=0.9988, intent='global_select', intentConfidence=0.9988, slots=[Slot{name='serial', rawValue='第三个', value=3, confidence=1.0}]}, storyId='navigation1639979605307', dynSceneIds=null, storyState='null'}
--------返回第二轮语义结果给CarSpeechService--------

12-20 13:53:25.314  6781  6813 I DialogConsole: DM status =continue
12-20 13:53:25.314  6781  6813 I XPLocalNlp: parseLocalDialogResult 200，status：continue (T:2315)(C:carspeechservice)at (XPLocalNlp.java:129)
12-20 13:53:25.315  6781  6813 I XPLocalNlp: parseAnswers command://navi.control.start (T:2315)(C:carspeechservice)at (XPLocalNlp.java:217)
12-20 13:53:25.316  6781  6813 I XPLocalNlp: localDialogListener parseLocalDialogResult NLUResult{nluId=0, sessionId='7b2977b8-7d51-4148-93c0-393a99758d1c', domain='navigation', showText='好的', asrResource='ower_local',EventIntent=[EventIntent{intent='3', event='command://navi.control.start', delay=0, param={"naviType":1,"poi":{"naviLat":23.132118,"naviLon":113.382254,"latitude":23.132118,"longitude":113.382254,"entrLocation":{"latitude":23.132118,"longitude":113.382254}}}, xiaopExpression=null, showText=好的, nlgText=好的, tips=null}]'} (T:2315)(C:carspeechservice)at (XPLocalNlp.java:109)
.867  6781  6823 I UploadSpeechDataModel: uploadSpeechData, data = {"endReason":"timeout","dmEndTime":1639981053859,"eventId":301,"hwVersion":"unknown","ddsNlu":{"isCancel":false,"nluId":102},"localNlu":{"isCancel":false,"nluId":103},"location":"{\"city\":\"广州市\",\"latitude\":23.159581944444444,\"longitude\":113.38507055555556}","nluResult":{"nluId":102},"xpNlu":{"isCancel":false,"nluId":101},"numberOfSatellites":1,"packageName":"com.xiaopeng.montecarlo","sessionId":"97a95969-e805-4054-8802-eec50fd2d0e3","soundLocation":0,"soundZoneMode":0,"spendTime":{"cloudAsrFinalTextTimeStamp":0,"cloudAsrFirstTextTimeStamp":0,"ddsLocalAsrFinalTextTimeStamp":0,"feedAsrFirstDataTimeStamp":0,"feedCloudAsrToCloudDmpTimeStamp":0,"feedCloudAsrToLocalDmpTimeStamp":0,"feedLocalAsrToLocalDmpTimeStamp":0,"feedNlgResultToTtsTimeStamp":1639981049594,"localAsrFinalTextTimeStamp":0,"localAsrFirstTextTimeStamp":0,"qCloudAsrAndCloudNluTime":0,"qCloudAsrAndLocalNluTime":0,"qCloudAsrCostTime":0,"qCloudAsrFinalTextTime":0,"qCloudAsrFirstTextTime":0,"qCloudAsrToCloudDmpTime":0,"qCloudAsrToLocalBotTime":0,"qCloudAsrToLocalDmpTime":0,"qCloudAsrToLocalNluTime":0,"qDdsLocalAsrCostTime":0,"qDdsLocalAsrFinalTextTime":0,"qLocalAsrAndLocalNluTime":0,"qLocalAsrCostTime":0,"qLocalAsrFinalTextTime":0,"qLocalAsrFirstTextTime":0,"qLocalAsrToLocalBotTime":0,"qLocalAsrToLocalDmpTime":0,"qLocalAsrToLocalNluTime":0,"reCloudAsrToCloudDmpTimeStamp":0,"reCloudAsrToLocalBotTimeStamp":0,"reCloudAsrToLocalDmpTimeStamp":0,"reCloudAsrToLocalNluTimeStamp":0,"reLocalAsrToLocalBotTimeStamp":0,"reLocalAsrToLocalDmpTimeStamp":0,"reLocalAsrToLocalNluTimeStamp":0,"startListenTimeStamp":0,"vadEndTimeStamp":0,"vadStartTimeStamp":0,"wakeupTimeStamp":0},"speechCode":"190","speechVersionName":"2.9.0","speed":0.0,"startTime":1639981049656,"talkId":"d278328922cea016512f5e77cc45f8df","userId":"XPENGD55408094130EA0EB2D","vadRMSReachTime":0,"vadRMSThreshold":0,"voiceStartInterval":0,"volume":1,"windStrength":0,"windowStates":[0.0,0.0,0.0,0.0],"xpAsrResult":{"asrResult":{}},"xpLocalResult":{"xpCloudAsrAndLocalNlu":{"nluId":0},"xpLocalAsrAndLocalNlu":{"nluId":0}}} (T:2325)(C:carspeechservice)at (UploadSpeechDataModel.java:903)


```



### 场景管理

由于VUI场景不是本地的重点，下面主要阐述的是动态场景管理。

场景管理模块接收导航Bot传入的导航相关数据，将其按照一定规则封装成动态场景数据，用于场景NLU解析。所以从定义上来看，动态场景管理主要的职责包含

1. 封装动态场景
2. 缓存动态场景
3. 提供动态场景查询接口

动态场景内存在三种类型的数据

| 类型                        | 简介         | 职责                           | 举例                                        |
| --------------------------- | ------------ | ------------------------------ | ------------------------------------------- |
| CommandSpace                | 命令类空间   | 多轮中需要选择的业务           | 例如，确定/取消；例如，确认打开清洁模式吗？ |
| ContentSpace                | 内容类空间   | 主要是导航/电话/音乐的选择列表 | 导航目的地找到N个目的地，请选择             |
| *SlotSpace*（目前暂不支持） | *填槽类空间* | *槽位填充相关*                 | *槽位填充类     例如，需要输入POI地址*      |



类结构：

![image-20211220133931822](https://gitee.com/moonsky/image-bed/raw/master/image-20211220133931822.png)

### Bot Story状态管理

首先这里阐述一下Story的概念，一次连续的会话被认定为一个story，也就是这几轮对话都是围绕一个特定意图。

目前一个领域的bot只有一个实例存在，所以活跃的story也是唯一的，但为了方便追踪当前story的状态，通过一些固定的状态来定义story的每个阶段。

下面就以导航场景下的story state配置文件举例

```json
{
  "domain": "navigation",
  "states": [{
    "name": "state_poi_search_start",
    "triggers":[//触发条件，只要命中一个，就可以进入该状态
      {"intent":"navigation_destination","slots": ["poi_type","poi_entity"]},
      {"intent":"navigation_search","slots": ["poi_name"]}
    ],
    "isFinalState":0//是否是最终状态（目前用来判断是否将botResult设置为continue）0-不是最终状态 1-最终状态
  },{
    "name": "state_poi_search_no_result",
    "isFinalState":1,
    "tts": "没找到您说的地点，请换个说法再试试吧" //该状态下对应的tts
  },{
    "name": "state_poi_search_multi_result",
    "isFinalState":0,
    "tts": "结果是第几个"
  },{
    "name": "state_poi_search_one_result",
    "isFinalState":0,
    "tts": "我找到一个地址，确定导航吗"
  },{
    "name": "state_poi_search_custom_result",
    "isFinalState":1,
    "tts": "好的，开始导航"
  },{
    "name": "state_poi_search_confirm",
    "isFinalState":1,
    "triggers":[
      {"intent":"global_select"}
    ],
    "tts": "好的"
  },{
    "name": "state_poi_search_cancel",
    "isFinalState":1,
    "triggers":[
      {"intent":"cancel"}
    ],
    "tts": "好的"
  }]
}
```

为了方便解析Bot对应的story state json文件，特此创建了一个StoryStateHelper类，它的职责是

1. 加载指定目录下json文件，并转换成story state对象
2. 根据NLU返回的结果中的intent获取当前触发的状态
3. 依据state name获取相关state

类图：

![image-20211221164320535](https://gitee.com/moonsky/image-bed/raw/master/image-20211221164320535.png)
